// popup-script.js - Wersja z debugowaniem

console.log('üöÄ Popup script loaded');

// Sprawd≈∫ czy elementy istniejƒÖ
document.addEventListener('DOMContentLoaded', function() {
  console.log('üìã DOM loaded, checking elements...');
  
  // Sprawd≈∫ wszystkie elementy
  const platformBtns = document.querySelectorAll('.platform-btn');
  const analysisTypeBtns = document.querySelectorAll('.analysis-type-btn');
  const modelSelection = document.getElementById('model-selection');
  const modelSelect = document.getElementById('model-select');
  const buttonPositionSelect = document.getElementById('button-position');
  const buttonStyleSelect = document.getElementById('button-style');
  const saveBtn = document.getElementById('save-btn');
  const statusMessage = document.getElementById('status-message');
  const customPrompt = document.getElementById('custom-prompt');
  const templateBtns = document.querySelectorAll('.template-btn');
  
  console.log('üîç Element check:');
  console.log('- Platform buttons:', platformBtns.length);
  console.log('- Analysis type buttons:', analysisTypeBtns.length);
  console.log('- Model selection:', !!modelSelection);
  console.log('- Model select:', !!modelSelect);
  console.log('- Button position select:', !!buttonPositionSelect);
  console.log('- Button style select:', !!buttonStyleSelect);
  console.log('- Save button:', !!saveBtn);
  console.log('- Status message:', !!statusMessage);
  console.log('- Custom prompt:', !!customPrompt);
  console.log('- Template buttons:', templateBtns.length);
  
  // Toggles
  const newTabToggle = document.getElementById('new-tab-toggle');
  const notificationsToggle = document.getElementById('notifications-toggle');
  const autoSendToggle = document.getElementById('auto-send-toggle');
  
  console.log('- New tab toggle:', !!newTabToggle);
  console.log('- Notifications toggle:', !!notificationsToggle);
  console.log('- Auto send toggle:', !!autoSendToggle);
  
  if (platformBtns.length === 0) {
    console.error('‚ùå No platform buttons found!');
    return;
  }
  
  console.log('‚úÖ All elements found, setting up...');
  loadSettings();
  setupEventListeners();
});

// Modele dla r√≥≈ºnych platform
const models = {
  chatgpt: [
    { value: 'gpt-4o', text: 'GPT-4o (najnowszy)' },
    { value: 'o3', text: 'o3 (szybki)' }
  ],
  claude: [
    { value: 'claude-3-5-sonnet', text: 'Claude 3.5 Sonnet (Najnowszy)' },
    { value: 'claude-3-opus', text: 'Claude 3 Opus (Najlepszy)' },
    { value: 'claude-3-sonnet', text: 'Claude 3 Sonnet (Zbalansowany)' },
    { value: 'claude-3-haiku', text: 'Claude 3 Haiku (Szybki)' }
  ]
};

// Szablony prompt√≥w
const promptTemplates = {
  default: `Analizuj tƒô transkrypcjƒô z YouTube w jƒôzyku polskim:

üì∫ **Tytu≈Ç:** {title}
üîó **Link:** {url}

**Stw√≥rz analizƒô zawierajƒÖcƒÖ:**
1. **G≈Ç√≥wne tematy** - najwa≈ºniejsze zagadnienia
2. **Kluczowe informacje** - fakty, dane, wnioski  
3. **Praktyczne wskaz√≥wki** - konkretne rady (je≈õli sƒÖ)
4. **Najwa≈ºniejsze cytaty** - warto≈õciowe stwierdzenia

Napisz zwiƒô≈∫le ale kompletnie, 300-500 s≈Ç√≥w.

---
**TRANSKRYPCJA:**
{transcript}`,

  summary: `Podsumuj tƒô transkrypcjƒô z YouTube w jƒôzyku polskim:

üì∫ **Tytu≈Ç:** {title}
üîó **Link:** {url}

**Stw√≥rz podsumowanie zawierajƒÖce:**
1. **G≈Ç√≥wne tematy** - najwa≈ºniejsze zagadnienia
2. **Kluczowe informacje** - fakty, dane, wnioski  
3. **Praktyczne wskaz√≥wki** - konkretne rady (je≈õli sƒÖ)
4. **Najwa≈ºniejsze cytaty** - warto≈õciowe stwierdzenia

Napisz zwiƒô≈∫le ale kompletnie, 300-500 s≈Ç√≥w.

---
**TRANSKRYPCJA:**
{transcript}`,

  analysis: `Przeprowad≈∫ dog≈ÇƒôbnƒÖ analizƒô tej transkrypcji z YouTube:

**üéØ Wideo:** {title}
**üîó ≈πr√≥d≈Ço:** {url}

**Proszƒô o analizƒô obejmujƒÖcƒÖ:**
- G≈Ç√≥wne argumenty i tezy
- Stosowane przyk≈Çady i dowody
- Silne i s≈Çabe strony prezentacji
- Praktyczne wnioski i zastosowania
- Ocenƒô warto≈õci merytorycznej

**TRANSKRYPCJA DO ANALIZY:**
{transcript}`,

  bullet: `Przekszta≈Çƒá tƒô transkrypcjƒô YouTube w przejrzyste punkty kluczowe:

üì∫ **{title}**
üîó {url}

**Format odpowiedzi:**
- **G≈Ç√≥wne tematy** - lista najwa≈ºniejszych zagadnie≈Ñ
- **Kluczowe fakty** - konkretne informacje i dane
- **Praktyczne wskaz√≥wki** - actionable insights
- **Wa≈ºne cytaty** - najlepsze fragmenty

**TRANSKRYPCJA:**
{transcript}`,

  custom: `{transcript}`
};

// Konfiguracja nas≈Çuchiwaczy zdarze≈Ñ
function setupEventListeners() {
  console.log('üîß Setting up event listeners...');
  
  const platformBtns = document.querySelectorAll('.platform-btn');
  const analysisTypeBtns = document.querySelectorAll('.analysis-type-btn');
  const modelSelection = document.getElementById('model-selection');
  const modelSelect = document.getElementById('model-select');
  const saveBtn = document.getElementById('save-btn');
  const statusMessage = document.getElementById('status-message');
  const customPrompt = document.getElementById('custom-prompt');
  const templateBtns = document.querySelectorAll('.template-btn');
  const newTabToggle = document.getElementById('new-tab-toggle');
  const notificationsToggle = document.getElementById('notifications-toggle');
  const autoSendToggle = document.getElementById('auto-send-toggle');
  
  // Obs≈Çuga wyboru platformy
  platformBtns.forEach((btn, index) => {
    console.log(`üéØ Setting up platform button ${index}:`, btn.dataset.platform);
    btn.addEventListener('click', function() {
      console.log('üéØ Platform clicked:', btn.dataset.platform);
      
      // Usu≈Ñ aktywne klasy
      platformBtns.forEach(b => b.classList.remove('active'));
      // Dodaj aktywnƒÖ klasƒô do klikniƒôtego przycisku
      btn.classList.add('active');
      
      const platform = btn.dataset.platform;
      updateModelSelection(platform);
    });
  });

  // Obs≈Çuga wyboru typu analizy
  analysisTypeBtns.forEach((btn, index) => {
    console.log(`üîç Setting up analysis button ${index}:`, btn.dataset.type);
    btn.addEventListener('click', function() {
      console.log('üîç Analysis type clicked:', btn.dataset.type);
      
      // Usu≈Ñ aktywne klasy
      analysisTypeBtns.forEach(b => b.classList.remove('active'));
      // Dodaj aktywnƒÖ klasƒô do klikniƒôtego przycisku
      btn.classList.add('active');
    });
  });

  // Obs≈Çuga toggles
  if (newTabToggle) {
    console.log('üîÑ Setting up new tab toggle');
    newTabToggle.addEventListener('click', () => {
      console.log('üîÑ New tab toggle clicked');
      toggleSetting(newTabToggle);
    });
  }

  if (notificationsToggle) {
    console.log('üîî Setting up notifications toggle');
    notificationsToggle.addEventListener('click', () => {
      console.log('üîî Notifications toggle clicked');
      toggleSetting(notificationsToggle);
    });
  }

  if (autoSendToggle) {
    console.log('üöÄ Setting up auto send toggle');
    autoSendToggle.addEventListener('click', () => {
      console.log('üöÄ Auto send toggle clicked');
      toggleSetting(autoSendToggle);
    });
  }

  // Obs≈Çuga szablon√≥w prompt√≥w
  templateBtns.forEach((btn, index) => {
    console.log(`üìù Setting up template button ${index}:`, btn.dataset.template);
    btn.addEventListener('click', function() {
      console.log('üìù Template clicked:', btn.dataset.template);
      
      // Usu≈Ñ aktywne klasy
      templateBtns.forEach(b => b.classList.remove('active'));
      // Dodaj aktywnƒÖ klasƒô
      btn.classList.add('active');
      
      const template = btn.dataset.template;
      if (template !== 'custom' && customPrompt) {
        customPrompt.value = promptTemplates[template] || '';
      } else if (customPrompt) {
        customPrompt.focus();
      }
    });
  });

  // Obs≈Çuga zapisywania
  if (saveBtn) {
    console.log('üíæ Setting up save button');
    saveBtn.addEventListener('click', function() {
      console.log('üíæ Save button clicked');
      saveSettings();
    });
  }

  // Obs≈Çuga zmiany modelu
  if (modelSelect) {
    console.log('üîß Setting up model select');
    modelSelect.addEventListener('change', function() {
      console.log('üîß Model changed:', modelSelect.value);
    });
  }
  
  console.log('‚úÖ All event listeners set up');
}

// ≈Åadowanie ustawie≈Ñ
function loadSettings() {
  console.log('üì• Loading settings...');
  
  chrome.storage.sync.get([
    'ai_platform', 
    'ai_model', 
    'analysis_type',
    'new_tab',
    'notifications',
    'auto_send',
    'custom_prompt',
    'button_position',
    'button_style'
  ], function(result) {
    console.log('üìä Loaded settings:', result);
    
    const platformBtns = document.querySelectorAll('.platform-btn');
    const analysisTypeBtns = document.querySelectorAll('.analysis-type-btn');
    const modelSelect = document.getElementById('model-select');
    const customPrompt = document.getElementById('custom-prompt');
    const templateBtns = document.querySelectorAll('.template-btn');
    const newTabToggle = document.getElementById('new-tab-toggle');
    const notificationsToggle = document.getElementById('notifications-toggle');
    const autoSendToggle = document.getElementById('auto-send-toggle');
    
    // Platforma
    const platform = result.ai_platform || 'chatgpt';
    console.log('üéØ Setting platform to:', platform);
    
    // Usu≈Ñ wszystkie aktywne klasy
    platformBtns.forEach(btn => btn.classList.remove('active'));
    
    // Dodaj aktywnƒÖ klasƒô do wybranej platformy
    const selectedPlatformBtn = document.querySelector(`[data-platform="${platform}"]`);
    if (selectedPlatformBtn) {
      selectedPlatformBtn.classList.add('active');
      console.log('‚úÖ Platform button activated:', platform);
    } else {
      console.error('‚ùå Platform button not found for:', platform);
    }

    // Typ analizy
    const analysisType = result.analysis_type || 'summary';
    console.log('üîç Setting analysis type to:', analysisType);
    
    // Usu≈Ñ wszystkie aktywne klasy
    analysisTypeBtns.forEach(btn => btn.classList.remove('active'));
    
    // Dodaj aktywnƒÖ klasƒô do wybranego typu
    const selectedAnalysisBtn = document.querySelector(`[data-type="${analysisType}"]`);
    if (selectedAnalysisBtn) {
      selectedAnalysisBtn.classList.add('active');
      console.log('‚úÖ Analysis type button activated:', analysisType);
    } else {
      console.error('‚ùå Analysis type button not found for:', analysisType);
    }
    
    // Zaktualizuj wyb√≥r modelu
    updateModelSelection(platform);
    
    // Ustaw model je≈õli jest zapisany
    if (result.ai_model && modelSelect) {
      modelSelect.value = result.ai_model;
      const optionExists = Array.from(modelSelect.options).some(
        opt => opt.value === result.ai_model
      );
      if (!optionExists) {
        modelSelect.value = modelSelect.options[0].value;
      }
      console.log('üîß Model set to:', modelSelect.value);
    }
    
    // Toggles
    if (result.new_tab !== false && newTabToggle) {
      newTabToggle.classList.add('active');
      console.log('‚úÖ New tab toggle activated');
    }
    if (result.notifications !== false && notificationsToggle) {
      notificationsToggle.classList.add('active');
      console.log('‚úÖ Notifications toggle activated');
    }
    if (result.auto_send !== false && autoSendToggle) {
      autoSendToggle.classList.add('active');
      console.log('‚úÖ Auto send toggle activated');
    }

    if (buttonPositionSelect) {
      buttonPositionSelect.value = result.button_position || 'middle-right';
      console.log('üìç Button position set to:', buttonPositionSelect.value);
    }

    if (buttonStyleSelect) {
      buttonStyleSelect.value = result.button_style || 'gradient';
      console.log('üé® Button style set to:', buttonStyleSelect.value);
    }
    
    // Custom prompt
    if (result.custom_prompt && customPrompt) {
      customPrompt.value = result.custom_prompt;
      console.log('üìù Custom prompt loaded');
      
      // Znajd≈∫ odpowiedni szablon
      const matchingTemplate = Object.keys(promptTemplates).find(key => 
        promptTemplates[key] === result.custom_prompt
      );
      
      if (matchingTemplate) {
        // Usu≈Ñ wszystkie aktywne klasy z szablon√≥w
        templateBtns.forEach(btn => btn.classList.remove('active'));
        // Dodaj aktywnƒÖ klasƒô do odpowiedniego szablonu
        const templateBtn = document.querySelector(`[data-template="${matchingTemplate}"]`);
        if (templateBtn) {
          templateBtn.classList.add('active');
          console.log('‚úÖ Template activated:', matchingTemplate);
        }
      } else {
        // Je≈õli nie ma dopasowania, ustaw jako custom
        templateBtns.forEach(btn => btn.classList.remove('active'));
        const customBtn = document.querySelector('[data-template="custom"]');
        if (customBtn) {
          customBtn.classList.add('active');
          console.log('‚úÖ Custom template activated');
        }
      }
    } else {
      // Domy≈õlny szablon
      if (customPrompt) {
        customPrompt.value = promptTemplates.default;
        console.log('üìù Default prompt loaded');
      }
      templateBtns.forEach(btn => btn.classList.remove('active'));
      const defaultBtn = document.querySelector('[data-template="default"]');
      if (defaultBtn) {
        defaultBtn.classList.add('active');
        console.log('‚úÖ Default template activated');
      }
    }
    
    console.log('‚úÖ Settings loaded successfully');
  });
}

// Aktualizacja wyboru modelu
function updateModelSelection(platform) {
  console.log('üîß Updating model selection for platform:', platform);
  
  const modelSelect = document.getElementById('model-select');
  const modelSelection = document.getElementById('model-selection');
  
  if (!modelSelect) {
    console.log('‚ùå Model select element not found');
    return;
  }
  
  const platformModels = models[platform] || models.chatgpt;
  
  // Wyczy≈õƒá obecne opcje
  modelSelect.innerHTML = '';
  
  // Dodaj nowe opcje
  platformModels.forEach(model => {
    const option = document.createElement('option');
    option.value = model.value;
    option.textContent = model.text;
    modelSelect.appendChild(option);
  });

  // Poka≈º/ukryj selekcjƒô modelu
  if (modelSelection) {
    if (platform === 'claude') {
      modelSelection.style.display = 'none';
      console.log('üôà Model selection hidden for Claude');
    } else {
      modelSelection.style.display = 'block';
      console.log('üëÅÔ∏è Model selection shown for ChatGPT');
    }
  }
  
  console.log('‚úÖ Model selection updated');
}

// Prze≈ÇƒÖczanie ustawie≈Ñ
function toggleSetting(toggle) {
  if (toggle) {
    toggle.classList.toggle('active');
    console.log('üîÑ Toggle switched:', toggle.classList.contains('active'));
  }
}

// Zapisywanie ustawie≈Ñ
function saveSettings() {
  console.log('üíæ Saving settings...');
  
  const platformBtns = document.querySelectorAll('.platform-btn');
  const analysisTypeBtns = document.querySelectorAll('.analysis-type-btn');
  const modelSelect = document.getElementById('model-select');
  const customPrompt = document.getElementById('custom-prompt');
  const newTabToggle = document.getElementById('new-tab-toggle');
  const notificationsToggle = document.getElementById('notifications-toggle');
  const autoSendToggle = document.getElementById('auto-send-toggle');
  const buttonPositionSelect = document.getElementById('button-position');
  const buttonStyleSelect = document.getElementById('button-style');
  const saveBtn = document.getElementById('save-btn');
  const statusMessage = document.getElementById('status-message');
  
  // Znajd≈∫ aktywnƒÖ platformƒô
  const activePlatformBtn = document.querySelector('.platform-btn.active');
  const activePlatform = activePlatformBtn ? activePlatformBtn.dataset.platform : 'chatgpt';

  // Znajd≈∫ aktywny typ analizy
  const activeAnalysisBtn = document.querySelector('.analysis-type-btn.active');
  const activeAnalysisType = activeAnalysisBtn ? activeAnalysisBtn.dataset.type : 'summary';
  
  const selectedModel = modelSelect ? modelSelect.value : 'gpt-4o';
  const promptText = customPrompt ? customPrompt.value.trim() : '';
  
  const settings = {
    ai_platform: activePlatform,
    ai_model: selectedModel,
    analysis_type: activeAnalysisType,
    new_tab: newTabToggle ? newTabToggle.classList.contains('active') : true,
    notifications: notificationsToggle ? notificationsToggle.classList.contains('active') : true,
    auto_send: autoSendToggle ? autoSendToggle.classList.contains('active') : true,
    custom_prompt: promptText,
    button_position: buttonPositionSelect ? buttonPositionSelect.value : 'middle-right',
    button_style: buttonStyleSelect ? buttonStyleSelect.value : 'gradient'
  };

  console.log('üìä Settings to save:', settings);

  // Zablokuj przycisk podczas zapisywania
  if (saveBtn) {
    saveBtn.disabled = true;
    saveBtn.textContent = '‚è≥ Zapisywanie...';
  }

  chrome.storage.sync.set(settings, function() {
    // Odblokuj przycisk
    if (saveBtn) {
      saveBtn.disabled = false;
      saveBtn.textContent = 'üíæ Zapisz ustawienia';
    }
    
    if (chrome.runtime.lastError) {
      console.error('‚ùå Error saving settings:', chrome.runtime.lastError);
      showStatus('B≈ÇƒÖd podczas zapisywania ustawie≈Ñ!', 'error');
    } else {
      console.log('‚úÖ Settings saved successfully');
      showStatus('‚úÖ Ustawienia zosta≈Çy zapisane!', 'success');

      // Powiadom zak≈Çadki YouTube o zmianie ustawie≈Ñ
      chrome.tabs.query({ url: '*://*.youtube.com/*' }, function(tabs) {
        tabs.forEach(tab => {
          chrome.tabs.sendMessage(tab.id, { action: 'refreshButton' });
        });
      });

      // Ukryj status po 3 sekundach
      setTimeout(() => {
        if (statusMessage) {
          statusMessage.style.display = 'none';
        }
      }, 3000);
    }
  });
}

// Pokazywanie statusu
function showStatus(message, type) {
  const statusMessage = document.getElementById('status-message');
  if (!statusMessage) return;
  
  statusMessage.textContent = message;
  statusMessage.className = `status-message status-${type}`;
  statusMessage.style.display = 'block';
  
  console.log(`üì¢ Status: ${message} (${type})`);
}

console.log('üì¶ Popup script setup completed');